---
title: "Visualization Playground"
author: "BACOU, Melanie"
date: "`r format(Sys.Date(), '%b. %d, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualization Playground}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css, echo=FALSE}
.pagedtable-wrapper { border: unset; }
.pagedtable-not-empty .pagedtable-footer { border-top: unset; }
.pagedtable-header-name { overflow: unset; }
```

Collection of visuals for WA Dashboard.

```{r, message=FALSE}
library(rmarkdown)
library(shiny)

# Load this development package
devtools::load_all(".")

data <- DATA[iso3=="ken"]
```


# Water Availability

## Basin Closure

(ratio of utilized flow[^s1]/net inflow[^s1])

```{r}
# Verify data periodicity
data[, .N, by=.(sheet, period)]
```

Note that seasonal time-series have not been ingested yet, but will be available in the dashboard.

```{r}
# Yearly
dt <- data[id %in% c("utilized_flow", "net_inflow") & period=="year"]
dt <- dcast(dt, ...~id)[, value := 100 * utilized_flow / net_inflow]

plot_ts(dt, name="Pct. basin closure", unit="%",
  title="Mara Basin Closure", subtitle="Kenya 2003-2017 (%)")
```

## Availability per Capita

(ratio of consumed[^s1]/population[^ext])

```{r, layout="l-screen"}

# Basin population from config
tot_pop <- ISO3[["ken"]]$population

# Yearly
dt <- data[id %in% c("consumed_water") & period=="year"]
dt <- dcast(dt, ...~id)[, value := 1E9 * consumed_water / tot_pop]

plot_ts(dt, name="Per Capita  Water Consumption", unit="m³",
  title="Mara Basin Per Capita Water Consumption", subtitle="Kenya 2003-2017 (m³)")
```

```{r, layout="l-screen"}
# Monthly profile

dt <- data[id %in% c("consumed_water") & period=="month"]
dt <- dcast(dt, ...~id)[, value := 1E9 * consumed_water / tot_pop]

plot_profile(dt, unit="km³",
  title="Mara Basin Per Capita Water Consumption", subtitle="Kenya 2003-2017 (km³)")
```

Shows entire period stats and 3 most recent years (can also be polar, see below).


## Water Available for Further Use

(utilizable outflow[^s1])

```{r}
# Yearly
dt <- data[id %in% c("utilized_flow") & period=="year"]
dt <- dcast(dt, ...~id)[, value := 1000 * utilized_flow]

plot_ts(dt, name="Utilizable Outflow", unit="MCM",
  title="Mara Basin Utilizable Outflow", subtitle="Kenya 2003-2017 (km³)")
```


# Water Use

## Agricultural water use 

(ratio of agricultural ET[^s2]/water consumed[^s1])

Using a dependency graph to show agriculture vs. non-ag uses (or other flow allocations).

```{r, out.height="340px"}
plot_wheel(iso3="ken",
  title="System Water Uses",
  subtitle="Kenya 2003-2017")
```

Using small multiples to show agriculture vs. non-ag uses (or other allocations).

```{r}

```

```{r, eval=FALSE}
# Yearly time-series
dt <- data[id %in% c("consumed_water", "agriculture") & period=="year"]
dt <- dcast(dt, ...~id)[, value := 100 * agriculture / consumed_water]

plot_ts(dt, unit="%",
  title="Agricultural water use", subtitle="Kenya - 2003 - 2017 (%)")
```

```{r, eval=FALSE}
# Monthly
dt <- data[id %in% c("consumed_water", "agriculture") & period=="month"]
dt <- dcast(dt, ...~id)[, value := 100 * agriculture / consumed_water]

plot_profile(dt, unit="%",
  title="Agricultural water use", subtitle="Kenya - 2003 - 2017 (%)")
```


## Environmental Stress 

(percentage of time (months in the time series) during which environmental flows are not met) – Manohar/Mansoor to advise calculation from CSV WA output).

<span class="bg-warning">We use a low threshold value (e.g. < 0.05). More details to follow.</span>

```{r, layout="l-screen"}
threshold = 0.05

# Yearly time-series
dt <- data[id %in% c("env_o", "nav_o", "com_o") & period=="month"]
dt <- dcast(dt, ...~id)[, value := rowSums(cbind(env_o, nav_o, com_o), na.rm=T)
][, .(
  date_end = max(date_end),
  date_start = min(date_end),
  value = 100 * sum(value <= threshold, na.rm=T)/.N
), by=.(iso3, year)]

plot_ts(dt, name="Insuffient Flow", unit="%",
  title="Mara Basin - Environmental Stress", 
  subtitle=sprintf("Kenya 2003-2017 (%% of months in period below %s km³)", 
    threshold)
)
```


# Basin Variability

## Precipitation 

(inter and intra-annual min and max over the time series)

<p class="bg-warning">Add option in dashboard for users to toggle units between volume and height.<p>

```{r}
# Monthly
dt <- data[id=="rainfall" & period=="month"]
dt <- dcast(dt, ...~id)[, value := rainfall]

plot_ts(dt, name="Precipitation", unit="m³",
  title="Precipitation", subtitle="Kenya 2003-2017 (km³ / month)")
```

```{r}
# Monthly profile
plot_profile(dt, unit="km³",
  title="Precipitation", subtitle="Kenya 2003-2017 (km³ / month)")
```

Intra-annual variability can also be shown as a polar chart:

```{r, out.height="500px"}
# Monthly profile
plot_profile(dt, unit="km³", polar=T,
  title="Precipitation", subtitle="Kenya 2003-2017 (km³ / month)")
```



[^s1]: Indicator from resource base sheet
[^ext]: Indicator from external database
[^s2]: Indicator from ET sheet

