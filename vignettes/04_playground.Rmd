---
title: "Visualization Playground"
author: "BACOU, Melanie"
date: "`r format(Sys.Date(), '%b. %d, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualization Playground}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css, echo=FALSE}
.pagedtable-wrapper { border: unset; }
.pagedtable-not-empty .pagedtable-footer { border-top: unset; }
.pagedtable-header-name { overflow: unset; }
```

Collection of visuals for WA Dashboard.

```{r, echo=FALSE, message=FALSE}
library(rmarkdown)
library(shiny)
library(scales)

#knitr::opts_chunk$set(code_folding="hide")

# Load this development package
devtools::load_all(".")
```

```{r}
data <- DATA[iso3=="ken"]
```

Plot helper functions:

```{r}

plot_ts <- function(data, name=NA, unit=NA, yrange=NULL, ...) {
  
  dt = copy(data)
  setnames(dt, "date_end", "date")
  
  dt[order(date), `:=`(
    # Running mean
    ltn = cumsum(value)/1:.N
  ), by=.(iso3)]
  
  # Infer period frequency (1=year, 2=season, 12=month, 36=dekad)
  freq = dt[, .N, by=year(date)][1, .N]
  
  tr = if(freq>1) {
    # Loess trend component
    ts(dt[, value], frequency=1) %>% stl("periodic")[[1]][, "trend"] 
  } else {
    # Linear trend
    predict(lm(value~date, dt))
  }
  
  dt[, trend := tr]
  yrange = if(missing(yrange)) dt[, range(value, na.rm=T)] else yrange
  
  # Period bands  
  xBands = lapply(dt[, seq(min(date), max(date), by="year")], function(x) list(
    from = datetime_to_timestamp(x),
    to = datetime_to_timestamp(ceiling_date(x, "year")),
    color = c("transparent", alpha(pal[["light"]], .4))[1+odd(year(x))]
  ))
  
  # Flags
  flag = dt[dt[, c(which.min(value), which.max(value))]
  ][, `:=`(
    label = c("Min.", "Max."),
    unit = unit
  )]
  
  highchart2(type="stock") %>%
    hc_add_dependency("modules/annotations.js") %>%
    hc_add_dependency("modules/stock.js") %>%
    hc_add_series(dt, type="line", name=name, hcaes(x=date, y=value),
      color=pal[[1]], lineWidth=1) %>%
    hc_add_series(dt, type="line", name="LTN", hcaes(x=date, y=ltn),
      color=pal[[2]], lineWidth=2, marker=list(symbol="circle")) %>%
    hc_add_series(dt, type="line", name="Trend", hcaes(x=date, y=trend),
      color=pal[["orange"]], lineWidth=2, marker=list(symbol="circle")) %>%
    
    hc_add_series(flag, type="flags",
      hcaes(x=date, y=value, title=sprintf('%s %s (%s %s)', label, year, comma(value), unit)),
      color=pal[["black"]], fillColor=pal[["light"]], 
      shape="squarepin", showInLegend=FALSE) %>%
    
    hc_legend(enabled=TRUE, align="right") %>%
    hc_tooltip(valueSuffix=unit, shared=TRUE) %>%
    hc_xAxis(type="datetime", plotBands=xBands) %>%
    hc_yAxis(min=yrange[1], max=yrange[2]) %>%
    hc_rangeSelector(enabled=(freq>1), inputEnabled=FALSE) %>%
    hc_navigator(enabled=FALSE) %>%
    hc_scrollbar(enabled=FALSE) %>%
    hc_chart(zoomType="x") %>%
    hc_themed(...)
}

```

```{r}

plot_profile <- function(data, unit=NA, yrange=NULL, ...) {
  
  # Label years  
  ymax = data[, max(year(date_start))]
  
  dt = data[, .(
    date = as.Date(min(format(date_start, "2021-%m-%d"))),
    value = mean(value, na.rm=T),
    sd = sd(value, na.rm=T),
    # Highlight past 3 years
    value_1 = mean(fifelse(year==max(year)-0, value, NA_real_), na.rm=T),
    value_2 = mean(fifelse(year==max(year)-1, value, NA_real_), na.rm=T),
    value_3 = mean(fifelse(year==max(year)-2, value, NA_real_), na.rm=T)
  ), by=.(iso3, month)][, `:=`(
    ymin = value-sd,
    ymax = value+sd
  )]
  
  yrange = if(missing(yrange)) dt[, range(date, rm=T)] else yrange
  
  # Monthly bands
  xBands = lapply(dt[, seq(as.Date(min(date)), as.Date(max(date)), by="month")], 
    function(x) list(
      from = datetime_to_timestamp(x),
      to = datetime_to_timestamp(ceiling_date(x, unit="month")-1),
      color = c("transparent", alpha(pal[["light"]], .4))[1+odd(month(x))]
    ))
  
  highchart2(type="stock") %>%
    hc_add_dependency("modules/stock.js") %>%
    hc_chart(zoomType="x") %>%
    hc_add_series(dt, type="arearange",
      hcaes(x=date, low=ymin, high=ymax), name="+/- Std. Dev.",
      color=pal[[2]], fillOpacity=.1, marker=list(enabled=FALSE)) %>%
    
    hc_add_series(dt, type="column", hcaes(x=date, y=value_3), name=ymax-2,
      color=alpha(pal[["orange"]], .3)) %>%
    hc_add_series(dt, type="column", hcaes(x=date, y=value_2), name=ymax-1,
      color=alpha(pal[["orange"]], .6)) %>%
    hc_add_series(dt, type="column", hcaes(x=date, y=value_1), name=ymax-0,
      color=alpha(pal[["orange"]], .9)) %>%
    
    hc_add_series(dt, type="line", hcaes(x=date, y=value), name="LTN",
      color=pal[[2]], lineWidth=2, marker=list(enabled=TRUE)) %>%
    
    hc_tooltip(valueSuffix=unit) %>%
    hc_legend(enabled=TRUE, align="right") %>%
    hc_xAxis(type="datetime", dateTimeLabelFormats=list(month="%e %b"),
      plotBands=xBands) %>%
    hc_themed(...)
  
}

```

# Water Availability

## Basin Closure

(ratio of utilized flow[^s1]/net inflow[^s1])

```{r, layout="l-screen"}

# Verify data periodicity
data[sheet=="sheet1", .N, by=period]

# Yearly
dt <- data[id %in% c("utilized_flow", "net_inflow") & period=="year"]
dt <- dcast(dt, ...~id)[, value := 100 * utilized_flow / net_inflow]

plot_ts(dt, name="Pct. basin closure", unit="%",
  title="Mara Basin Closure", subtitle="Kenya 2003-2017 (%)")
```

## Availability per Capita

(ratio of consumed[^s1]/population[^ext])

```{r, layout="l-screen"}

tot_pop <- 1280000

# Yearly
dt <- data[id %in% c("consumed_water") & period=="year"]
dt <- dcast(dt, ...~id)[, value := 1E6 * consumed_water / tot_pop]

plot_ts(dt, name="Per Capita  Water Consumption", unit="m³",
  title="Mara Basin Closure", subtitle="Kenya 2003-2017 (m³)")
```

```{r, layout="l-screen"}
# Monthly profile

dt <- data[id %in% c("consumed_water") & period=="month"]
dt <- dcast(dt, ...~id)[, value := 1E6 * consumed_water / tot_pop]

plot_profile(dt, unit="km³",
  title="Nara Basin Per Capita Water Consumption", subtitle="Kenya 2003-2017 (km³)")
```


## Available for further use

(utilizable outflow[^s1])

```{r, layout="l-screen"}

# Yearly
dt <- data[id %in% c("utilized_flow") & period=="year"]
dt <- dcast(dt, ...~id)[, value := utilized_flow]

plot_ts(dt, name="Utilizable Outflow", unit="km³",
  title="Mara Basin Utilizable Outflow", subtitle="Kenya 2003-2017 (km³)")
```


# Water Use

## Agricultural water use 

(ratio of agricultural ET[^s2]/water consumed[^s1])

```{r}



```

```{r, layout="l-screen", eval=FALSE}
# Verify periodicity
data[sheet=="sheet2", .N, by=period]

# Yearly time-series
dt <- data[id %in% c("consumed_water", "agriculture") & period=="year"]
dt <- dcast(dt, ...~id)[, value := 100 * agriculture / consumed_water]

plot_ts(dt, unit="%",
  title="Agricultural water use", subtitle="Kenya - 2003 - 2017 (%)")
```

```{r, layout="l-screen", eval=FALSE}
# Monthly
dt <- data[id %in% c("consumed_water", "agriculture") & period=="month"]
dt <- dcast(dt, ...~id)[, value := 100 * agriculture / consumed_water]

plot_profile(dt, unit="%",
  title="Agricultural water use", subtitle="Kenya - 2003 - 2017 (%)")
```


## Environmental Stress 

(percentage of time (months in the time series) during which environmental flows are not met) – Manohar/Mansoor to advise calculation from CSV WA output).

Note sure whether to use 0 (zero) as a threshold or a low value.

```{r, layout="l-screen"}
# Yearly time-series
dt <- data[id %in% c("env_o", "nav_o", "com_o") & period=="month"]
dt <- dcast(dt, ...~id)[, value := rowSums(cbind(env_o, nav_o, com_o), na.rm=T)
    ][, value := 100 * sum(value <= 0.05, na.rm=T)/.N, by=year]

plot_ts(dt, name="Insuffient Flow", unit="%",
  title="Mara Basin - Environmental Stress", subtitle="Kenya 2003-2017 (% of months in period)")
```

```{r, layout="l-screen"}
plot_profile(dt, unit="%",
  title="Mara Basin - Environmental Stress", subtitle="Kenya 2003-2017 (% of months in period)")
```


# Basin Variability

## Precipitation 

(inter and intra annual min and max over the time series)

```{r, layout="l-screen"}
# Monthly
dt <- data[id %in% c("rainfall") & period=="month"]
dt <- dcast(dt, ...~id)[, value := rainfall]

plot_ts(dt, name="Precipitation", unit="km³",
  title="Precipitation", subtitle="Kenya 2003-2017 (km³ / month)")
```

```{r, layout="l-screen"}
# Monthly profile
plot_profile(dt, unit="km³",
  title="Precipitation", subtitle="Kenya 2003-2017 (km³ / month)")
```



[^s1]: Indicator from resource base sheet
[^ext]: Indicator from external database
[^s2]: Indicator from ET sheet

